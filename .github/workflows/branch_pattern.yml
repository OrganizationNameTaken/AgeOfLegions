name: Branch Name Validation on Creation

on:
  create:

permissions:
  contents: write
  issues: write

jobs:
  validate-branch-name:
    if: github.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch name
        id: validate
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          PATTERN="^(feat|fix|chore|docs|refactor|style|test|perf)(\([a-zA-Z0-9-]+\))?\/[a-zA-Z0-9-]+$"
          
          echo "üîç Checking branch name: $BRANCH_NAME"
          
          if [[ $BRANCH_NAME =~ $PATTERN ]]; then
            echo "‚úÖ Branch name is valid!"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Branch name is INVALID!"
            echo "valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Get changes diff
        if: steps.validate.outputs.valid == 'false'
        id: get_diff
        run: |
          # Get the diff compared to main
          git fetch origin main
          DIFF=$(git diff origin/main...HEAD --stat)
          
          # Save diff to a file for easier handling
          git diff origin/main...HEAD > diff.txt
          
          # Get a summary of changes
          FILES_CHANGED=$(git diff origin/main...HEAD --name-only | tr '\n' ', ' | sed 's/,$//')
          
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "diff_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Ask Copilot for better branch name
        if: steps.validate.outputs.valid == 'false'
        id: copilot_suggest
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = context.ref.replace('refs/heads/', '');
            const filesChanged = process.env.FILES_CHANGED;
            const diffSummary = process.env.DIFF_SUMMARY;
            
            // Read diff file
            const fs = require('fs');
            let diffContent = '';
            try {
              diffContent = fs.readFileSync('diff.txt', 'utf8');
              // Limit diff size to avoid API limits (first 3000 chars)
              if (diffContent.length > 3000) {
                diffContent = diffContent.substring(0, 3000) + '\n... (truncated)';
              }
            } catch (error) {
              console.log('Could not read diff file:', error.message);
            }
            
            const prompt = `I tried to create a branch named "${branchName}" but it doesn't follow the required pattern:
            
            Pattern: ^(feat|fix|chore|docs|refactor|style|test|perf)(\\([a-zA-Z0-9-]+\\))?\\/[a-zA-Z0-9-]+$
            
            Files changed: ${filesChanged || 'Unknown'}
            
            Diff summary:
            ${diffSummary || 'No summary available'}
            
            Based on these changes, suggest a better branch name that follows the pattern. Only respond with the branch name, nothing else.`;
            
            try {
              // Use GitHub Copilot API
              const response = await github.request('POST /copilot_internal/v2/completion', {
                prompt: prompt,
                max_tokens: 50,
                temperature: 0.3
              });
              
              let suggestedName = response.data.choices[0].text.trim();
              // Clean up the response (remove quotes, backticks, etc.)
              suggestedName = suggestedName.replace(/[`"']/g, '').trim();
              
              core.setOutput('suggested_name', suggestedName);
              console.log('Suggested branch name:', suggestedName);
            } catch (error) {
              console.log('Copilot API error:', error.message);
              // Fallback: create a simple suggestion based on branch type
              const types = ['feat', 'fix', 'chore', 'docs', 'refactor', 'style', 'test', 'perf'];
              let suggestedType = 'feat';
              for (const type of types) {
                if (branchName.toLowerCase().includes(type)) {
                  suggestedType = type;
                  break;
                }
              }
              const simpleName = branchName.toLowerCase().replace(/[^a-z0-9-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
              const fallbackName = `${suggestedType}/${simpleName}`;
              core.setOutput('suggested_name', fallbackName);
              console.log('Using fallback suggestion:', fallbackName);
            }
        env:
          FILES_CHANGED: ${{ steps.get_diff.outputs.files_changed }}
          DIFF_SUMMARY: ${{ steps.get_diff.outputs.diff_summary }}

      - name: Create issue with suggestion
        if: steps.validate.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = context.ref.replace('refs/heads/', '');
            const suggestedName = process.env.SUGGESTED_NAME || 'feat/your-description';
            
            const issueBody = `## ‚ö†Ô∏è Branch \`${branchName}\` does not follow naming convention
            
            The branch you created does not follow the required naming convention.
            
            ### ü§ñ Suggested branch name:
            \`\`\`
            ${suggestedName}
            \`\`\`
            
            ### üìù Required format:
            \`\`\`
            <type>(<scope>)/<description>
            \`\`\`
            
            ### Valid types:
            - \`feat\` - A new feature
            - \`fix\` - A bug fix 
            - \`chore\` - Maintenance tasks
            - \`docs\` - Documentation changes
            - \`refactor\` - Code refactoring
            - \`style\` - Code style changes
            - \`test\` - Adding or updating tests
            - \`perf\` - Performance improvements
            
            ### ‚úÖ To fix this, run these commands:
            \`\`\`bash
            # Create the new branch with the suggested name
            git checkout -b ${suggestedName}
            
            # Push the new branch
            git push origin ${suggestedName}
            
            # Delete the old branch (optional)
            git push origin --delete ${branchName}
            \`\`\`
            
            ### Examples of valid branch names:
            - ‚úÖ \`feat/user-authentication\`
            - ‚úÖ \`fix/login-bug\`
            - ‚úÖ \`feat(api)/new-endpoint\`
            - ‚úÖ \`refactor(database)/optimize-queries\`
            - ‚ùå \`${branchName}\` (invalid)
            
            **Note:** This branch has NOT been deleted. You can rename it using the commands above.`;
            
            // Create issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Invalid branch name: ${branchName}`,
              body: issueBody,
              labels: ['invalid-branch-name', 'automated']
            });
            
            console.log(`Created issue #${issue.data.number}`);
        env:
          SUGGESTED_NAME: ${{ steps.copilot_suggest.outputs.suggested_name }}

      - name: Celebrate valid branch
        if: steps.validate.outputs.valid == 'true'
        run: |
          echo "üéâ Branch name follows the convention! Good job!"
          echo "Branch: ${{ github.ref_name }}"
