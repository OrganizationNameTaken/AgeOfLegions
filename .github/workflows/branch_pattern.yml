name: Branch Name Validation on Creation

on:
  create:

permissions:
  contents: write
  issues: write
  models: read

jobs:
  validate-branch-name:
    if: github.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch name
        id: validate
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          PATTERN="^(feat|fix|chore|docs|refactor|style|test|perf)(\([a-zA-Z0-9-]+\))?/[a-zA-Z0-9-]+$"

          echo "üîç Checking branch name: $BRANCH_NAME"

          if [[ $BRANCH_NAME =~ $PATTERN ]]; then
            echo "‚úÖ Branch name is valid!"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Branch name is INVALID!"
            echo "valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Get changes diff
        if: steps.validate.outputs.valid == 'false'
        id: get_diff
        run: |
          # Get the diff compared to main
          git fetch origin main
          DIFF=$(git diff origin/main...HEAD --stat)

          # Save diff to a file for easier handling
          git diff origin/main...HEAD > diff.txt

          # Get a summary of changes
          FILES_CHANGED=$(git diff origin/main...HEAD --name-only | tr '\n' ', ' | sed 's/,$//')

          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "diff_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Ask AI for better branch name
        if: steps.validate.outputs.valid == 'false'
        id: ai_suggest
        uses: actions/ai-inference@v2.0.2
        with:
          model: openai/gpt-4o-mini
          max-tokens: 100
          system-prompt: |
            You are a Git branch naming expert. You suggest branch names following the pattern:
            <type>(<scope>)/<description>
            
            Valid types: feat, fix, chore, docs, refactor, style, test, perf
            Scope is optional but helpful.
            Description should be lowercase with hyphens.
            
            Respond with ONLY the branch name, nothing else.
          prompt: |
            I created a branch named "${{ github.ref_name }}" but it doesn't follow the naming convention.

            Files changed: ${{ steps.get_diff.outputs.files_changed || 'Unknown' }}

            Diff summary:
            ${{ steps.get_diff.outputs.diff_summary || 'No summary available' }}

            Suggest a valid branch name that follows the pattern.

      - name: Clean up AI response
        if: steps.validate.outputs.valid == 'false'
        id: copilot_suggest
        run: |
          SUGGESTED="${{ steps.ai_suggest.outputs.response }}"
          # Remove quotes, backticks, and trim whitespace
          SUGGESTED=$(echo "$SUGGESTED" | tr -d '\`"' | xargs)
          echo "suggested_name=$SUGGESTED" >> $GITHUB_OUTPUT
          echo "‚ú® AI suggested branch name: $SUGGESTED"

      - name: Create issue with suggestion
        if: steps.validate.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = context.ref.replace('refs/heads/', '');
            const suggestedName = process.env.SUGGESTED_NAME || 'feat/your-description';

            const issueBody = `## ‚ö†Ô∏è Branch \`${branchName}\` does not follow naming convention

            The branch you created does not follow the required naming convention.

            ### ü§ñ Suggested branch name:
            \`\`\`
            ${suggestedName}
            \`\`\`

            ### üìù Required format:
            \`\`\`
            <type>(<scope>)/<description>
            \`\`\`

            ### Valid types:
            - \`feat\` - A new feature
            - \`fix\` - A bug fix 
            - \`chore\` - Maintenance tasks
            - \`docs\` - Documentation changes
            - \`refactor\` - Code refactoring
            - \`style\` - Code style changes
            - \`test\` - Adding or updating tests
            - \`perf\` - Performance improvements

            ### ‚úÖ To fix this, run these commands:
            \`\`\`bash
            # Create the new branch with the suggested name
            git checkout -b ${suggestedName}

            # Push the new branch
            git push origin ${suggestedName}

            # Delete the old branch (optional)
            git push origin --delete ${branchName}
            \`\`\`

            ### Examples of valid branch names:
            - ‚úÖ \`feat/user-authentication\`
            - ‚úÖ \`fix/login-bug\`
            - ‚úÖ \`feat(api)/new-endpoint\`
            - ‚úÖ \`refactor(database)/optimize-queries\`
            - ‚ùå \`${branchName}\` (invalid)

            **Note:** This branch has NOT been deleted. You can rename it using the commands above.`;

            // Create issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Invalid branch name: ${branchName}`,
              body: issueBody,
              labels: ['invalid-branch-name', 'automated']
            });

            console.log(`Created issue #${issue.data.number}`);
        env:
          SUGGESTED_NAME: ${{ steps.copilot_suggest.outputs.suggested_name }}

      - name: Celebrate valid branch
        if: steps.validate.outputs.valid == 'true'
        run: |
          echo "üéâ Branch name follows the convention! Good job!"
          echo "Branch: ${{ github.ref_name }}"
