name: Branch Name Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  push:
    branches-ignore:
      - main
      - master
      - develop

jobs:
  validate-branch-name:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name format
        id: check-branch
        run: |
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          PATTERN="^(feat|fix|chore|docs|refactor|style|test|perf)(\([a-zA-Z0-9-]+\))?\/[a-zA-Z0-9-]+$"
          
          echo "Branch name: $BRANCH_NAME"
          
          if [[ $BRANCH_NAME =~ $PATTERN ]]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "✅ Branch name is valid"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "❌ Branch name is invalid"
          fi

      - name: Comment on PR with error
        if: steps.check-branch.outputs.valid == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = context.payload.pull_request.head.ref;
            const message = `## ⚠️ Invalid Branch Name
            
            The branch name \`${branchName}\` does not follow the required naming convention.
            
            **Required format:**
            \`\`\`
            <type>(<scope>)/<description>
            \`\`\`
            
            **Type must be one of:**
            - \`feat\` - A new feature
            - \`fix\` - A bug fix
            - \`chore\` - Maintenance tasks
            - \`docs\` - Documentation changes
            - \`refactor\` - Code refactoring
            - \`style\` - Code style changes
            - \`test\` - Adding or updating tests
            - \`perf\` - Performance improvements
            
            **Scope (optional):** A word or hyphenated phrase in parentheses
            
            **Examples of valid branch names:**
            - \`feat/user-authentication\`
            - \`fix/login-bug\`
            - \`feat(api)/new-endpoint\`
            - \`refactor(database)/optimize-queries\`
            
            **Please rename your branch before continuing:**
            \`\`\`bash
            git branch -m ${branchName} <new-valid-name>
            git push origin -u <new-valid-name>
            git push origin --delete ${branchName}
            \`\`\`
            
            This PR will be automatically blocked from merging until the branch name is corrected.`;
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Invalid Branch Name')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: message
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });
            }

      - name: Add blocking label
        if: steps.check-branch.outputs.valid == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['invalid-branch-name', 'do-not-merge']
            });

      - name: Remove blocking label if valid
        if: steps.check-branch.outputs.valid == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'invalid-branch-name'
              });
            } catch (error) {
              // Label might not exist
            }
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'do-not-merge'
              });
            } catch (error) {
              // Label might not exist
            }

      - name: Fail workflow if invalid
        if: steps.check-branch.outputs.valid == 'false'
        run: |
          echo "::error::Branch name does not follow the required pattern"
          exit 1
