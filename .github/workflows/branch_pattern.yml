name: Branch Name Validation on Creation

on:
  create:

jobs:
  validate-branch-name:
    if: github.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch name
        id: validate
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          PATTERN="^(feat|fix|chore|docs|refactor|style|test|perf)(\([a-zA-Z0-9-]+\))?\/[a-zA-Z0-9-]+$"
          
          echo "üîç Checking branch name: $BRANCH_NAME"
          
          if [[ $BRANCH_NAME =~ $PATTERN ]]; then
            echo "‚úÖ Branch name is valid!"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Branch name is INVALID!"
            echo "valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Delete invalid branch and notify
        if: steps.validate.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = context.ref.replace('refs/heads/', '');
            
            // Create an issue to notify the user
            const issueBody = `## ‚ö†Ô∏è Branch \`${branchName}\` was automatically deleted
            
            The branch you created does not follow the required naming convention and has been **automatically deleted**.
            
            ### Required format:
            \`\`\`
            <type>(<scope>)/<description>
            \`\`\`
            
            ### Valid types:
            - \`feat\` - A new feature
            - \`fix\` - A bug fix  
            - \`chore\` - Maintenance tasks
            - \`docs\` - Documentation changes
            - \`refactor\` - Code refactoring
            - \`style\` - Code style changes
            - \`test\` - Adding or updating tests
            - \`perf\` - Performance improvements
            
            ### Examples of valid branch names:
            - ‚úÖ \`feat/user-authentication\`
            - ‚úÖ \`fix/login-bug\`
            - ‚úÖ \`feat(api)/new-endpoint\`
            - ‚úÖ \`refactor(database)/optimize-queries\`
            - ‚ùå \`${branchName}\` (invalid)
            
            ### To create a valid branch:
            \`\`\`bash
            git checkout -b <type>/<description>
            git push origin <type>/<description>
            \`\`\`
            
            **Note:** This branch protection is automatic. Please follow the naming convention.`;
            
            // Create issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Invalid branch name: ${branchName}`,
              body: issueBody,
              labels: ['invalid-branch-name', 'automated']
            });
            
            console.log(`Created issue #${issue.data.number}`);
            
            // Delete the branch
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branchName}`
              });
              console.log(`‚úÖ Deleted branch: ${branchName}`);
            } catch (error) {
              console.log(`‚ö†Ô∏è Could not delete branch: ${error.message}`);
            }

      - name: Celebrate valid branch
        if: steps.validate.outputs.valid == 'true'
        run: |
          echo "üéâ Branch name follows the convention! Good job!"
          echo "Branch: ${{ github.ref_name }}"
